// api/requests.ts
import { apiClient } from './client';

export interface Order {
  id: string | number;
  date?: string;
  description?: string;
  type?: string;
  device?: string;
  user?: string;
  status?: string;
  originalData?: any;
  [key: string]: any;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è windows-1251
const decodeWindows1251 = (text: any): string => {
  if (text === null || text === undefined) return '';
  if (typeof text !== 'string') return String(text);
  
  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (!text.includes('ÔøΩ') && /^[\x00-\x7F]*$/.test(text)) {
    return text;
  }
  
  try {
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤
    const bytes = new Uint8Array(text.length);
    for (let i = 0; i < text.length; i++) {
      bytes[i] = text.charCodeAt(i) & 0xFF;
    }
    
    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∫–∞–∫ windows-1251
    const decoder = new TextDecoder('windows-1251');
    return decoder.decode(bytes);
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç:', text.substring(0, 50));
    return text;
  }
};

export const requestsApi = {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ —Å –±—ç–∫–∞ (—Å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
  getOrders: async (): Promise<Order[]> => {
    try {
      console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫...');
      
      // –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
      const response = await apiClient.postWithDecoding('/getOrdersF', [], 'windows-1251');
      
      console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', response.length);
      
      if (response.length > 0) {
        console.log('üìã –ü—Ä–∏–º–µ—Ä –∑–∞—è–≤–∫–∏ (–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ):', response[0]);
        console.log('üîë –ö–ª—é—á–∏ –ø–µ—Ä–≤–æ–π –∑–∞—è–≤–∫–∏:', Object.keys(response[0]));
      }
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏
      const formattedOrders = response.map((order: any, index: number) => {
        const formattedOrder: Order = {
          id: order.id || `order_${index}`,
          date: order.date || '',
          description: order.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è',
          type: order.type || '–ù–µ —É–∫–∞–∑–∞–Ω',
          device: order.device || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          user: order.user || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω',
          status: mapStatus(order.status) || '–°–æ–∑–¥–∞–Ω–∞',
          originalData: order,
        };
        
        // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        Object.keys(order).forEach(key => {
          if (!(key in formattedOrder)) {
            formattedOrder[key] = order[key];
          }
        });
        
        return formattedOrder;
      });
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–∏–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      const statusStats = formattedOrders.reduce((acc: Record<string, number>, order: Order) => {
        const status = order.status || 'unknown';
        acc[status] = (acc[status] || 0) + 1;
        return acc;
      }, {});
      
      console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:', statusStats);
      console.log('üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫:', formattedOrders.length);
      
      return formattedOrders;
      
    } catch (error: any) {
      console.error('‚ùå –°–ø–æ—Å–æ–± 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —Å–ø–æ—Å–æ–± 2...', error);
      
      try {
        // –°–ø–æ—Å–æ–± 2: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ä—É—á–Ω—ã–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const response = await apiClient.post<any[]>('/getOrdersF', []);
        
        // –†—É—á–Ω–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è
        const decodedOrders = response.map((order: any) => {
          const decoded: any = {};
          Object.keys(order).forEach(key => {
            decoded[key] = decodeWindows1251(order[key]);
          });
          return decoded;
        });
        
        console.log('‚úÖ –°–ø–æ—Å–æ–± 2 —É—Å–ø–µ—à–µ–Ω, –∑–∞—è–≤–æ–∫:', decodedOrders.length);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
        const formattedOrders = decodedOrders.map((order: any, index: number) => {
          const formattedOrder: Order = {
            id: order.id || `order_${index}`,
            date: order.date || '',
            description: order.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è',
            type: order.type || '–ù–µ —É–∫–∞–∑–∞–Ω',
            device: order.device || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            user: order.user || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω',
            status: mapStatus(order.status) || '–°–æ–∑–¥–∞–Ω–∞',
            originalData: order,
          };
          
          Object.keys(order).forEach(key => {
            if (!(key in formattedOrder)) {
              formattedOrder[key] = order[key];
            }
          });
          
          return formattedOrder;
        });
        
        return formattedOrders;
        
      } catch (error2: any) {
        console.error('‚ùå –û–±–∞ —Å–ø–æ—Å–æ–±–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏:', error2);
        console.error('üìÑ –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error2.response?.data || error2.message);
        
        return getMockOrders();
      }
    }
  },
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
  updateOrderStatus: async (orderId: string | number, status: string): Promise<any> => {
    try {
      console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ ${orderId} –Ω–∞ "${status}"`);
      return await apiClient.post('/updateOrderStatusF', [{ orderId, status }]);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
      throw error;
    }
  },
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
  createOrder: async (orderData: Partial<Order>): Promise<any> => {
  try {
    console.log('üÜï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞):', orderData);
    
    // –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –æ–±—ã—á–Ω—ã–π POST
    try {
      const response = await apiClient.post('setNewOrderF', [orderData]);
      console.log('‚úÖ –û–±—ã—á–Ω—ã–π POST —É—Å–ø–µ—à–µ–Ω:', response);
      return response;
    } catch (error1) {
      console.log('‚ùå –û–±—ã—á–Ω—ã–π POST –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —Å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º...');
      
      // –í–∞—Ä–∏–∞–Ω—Ç 2: –° –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      const decodedResponse = await apiClient.postWithDecoding(
        'setNewOrderF', 
        [orderData], 
        'windows-1251'
      );
      console.log('‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:', decodedResponse);
      return decodedResponse;
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏:', error);
    throw error;
  }
  }

};

// –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤
const mapStatus = (status?: string): string => {
  if (!status) return '–°–æ–∑–¥–∞–Ω–∞';
  
  const statusMap: Record<string, string> = {
    // –ö–∏—Ä–∏–ª–ª–∏—Ü–∞
    '—Å–æ–∑–¥–∞–Ω–∞': '–°–æ–∑–¥–∞–Ω–∞',
    '–≤ —Ä–∞–±–æ—Ç–µ': '–í —Ä–∞–±–æ—Ç–µ',
    '–∑–∞–≤–µ—Ä—à–µ–Ω–∞': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
    '–∑–∞–∫—Ä—ã—Ç–∞': '–ó–∞–∫—Ä—ã—Ç–∞',
    '–æ—Ç–º–µ–Ω–µ–Ω–∞': '–û—Ç–º–µ–Ω–µ–Ω–∞',
    // –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏
    'created': '–°–æ–∑–¥–∞–Ω–∞',
    'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
    'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
    'closed': '–ó–∞–∫—Ä—ã—Ç–∞',
    'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞',
  };
  
  const lowerStatus = status.toLowerCase().trim();
  return statusMap[lowerStatus] || status;
};

// –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞)
const getMockOrders = (): Order[] => {
  console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
  
  return [
    { 
      id: '#00001', 
      date: '2025-12-20 10:02:01', 
      description: '–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã—Ö —Ä–∞–±–æ—Ç', 
      type: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', 
      device: '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ—Å—Ç—É–ø–∞ ‚Ññ3', 
      user: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.', 
      status: '–°–æ–∑–¥–∞–Ω–∞',
    },
    { 
      id: '#00002', 
      date: '2025-12-20 10:03:01', 
      description: '–ó–∞–º–µ–Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', 
      type: '–ó–∞–º–µ–Ω–∞', 
      device: '–î–∞—Ç—á–∏–∫ ‚Ññ5', 
      user: '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.', 
      status: '–í —Ä–∞–±–æ—Ç–µ',
    },
    { 
      id: '#00003', 
      date: '2025-12-20 10:04:01', 
      description: '–†–µ–º–æ–Ω—Ç –Ω–∞—Å–æ—Å–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏', 
      type: '–†–µ–º–æ–Ω—Ç', 
      device: '–ù–∞—Å–æ—Å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è ‚Ññ1', 
      user: '–°–∏–¥–æ—Ä–æ–≤ –°.–°.', 
      status: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
    },
  ];
};