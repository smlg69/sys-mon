import { useState, useCallback, useEffect } from "react";
import { hvacDataService } from "../services/hvacDataService";
import { equipmentTypeService } from "../services/equipmentTypeService";
import { apiClient } from "../api/client";
import { SystemParameter, TemperatureDataPoint } from "../types/equipment";

interface UseHVACDataReturn {
  parameters: SystemParameter[];
  chartData: TemperatureDataPoint[];
  loading: boolean;
  error: string | null;
  lastUpdate: string;
  refreshData: () => Promise<void>;
  rawData: any;
  equipmentTypes: any[];
  updateChartForEquipment: (equipmentType: any) => Promise<void>;
}

export const useHVACData = (pollingInterval: number = 10000): UseHVACDataReturn => {
  const [parameters, setParameters] = useState<SystemParameter[]>([]);
  const [chartData, setChartData] = useState<TemperatureDataPoint[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [lastUpdate, setLastUpdate] = useState<string>("");
  const [rawData, setRawData] = useState<any>(null);
  const [equipmentTypes, setEquipmentTypes] = useState<any[]>([]);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      console.log("ðŸ”„ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð–ÐšÐ¥...");
      
      const response = await apiClient.post("/getCurrentParamsF", [
        { system: "hvac", includeHistory: true },
      ]);

      if (response && Array.isArray(response) && response[0]) {
        const data = response[0];
        setRawData(data);
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´
        const extractedParams = hvacDataService.getAllSystemParameters(data);
        setParameters(extractedParams);

        // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚Ð¸Ð¿Ñ‹ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹
        if (equipmentTypes.length === 0) {
          const types = equipmentTypeService.getAllEquipmentTypes();
          setEquipmentTypes(types);
        }

        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
        if (equipmentTypes.length > 0) {
          const defaultType = equipmentTypes.find(t => t.backendField === "tu1") || equipmentTypes[0];
          if (defaultType) {
            const newChartData = hvacDataService.getChartDataForEquipment(data, defaultType);
            setChartData(newChartData);
          }
        } else if (data.tu && Array.isArray(data.tu)) {
          // Fallback Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
          const defaultEquipmentType = {
            id: "default",
            type: "Ñ‚ÐµÐ¿Ð»Ð¾Ð²Ð¾Ð¹ ÑƒÐ·ÐµÐ»",
            group: "hkÑ…",
            parameter: "Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°",
            displayName: "Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° ÐºÐ¾Ñ‚Ð»Ð°",
            unit: "Â°C",
            backendField: "tu1",
          };
          const newChartData = hvacDataService.getChartDataForEquipment(data, defaultEquipmentType);
          setChartData(newChartData);
        }

        setLastUpdate(new Date().toLocaleTimeString("ru-RU"));
        setError(null);
        console.log("âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð–ÐšÐ¥ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹");
      }
    } catch (err: any) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð–ÐšÐ¥:", err);
      setError(err.message || "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…");
      
      // Fallback Ð´Ð°Ð½Ð½Ñ‹Ðµ
      const fallbackData = hvacDataService.generateFallbackChartData(65, 24, "Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° ÐºÐ¾Ñ‚Ð»Ð°");
      setChartData(fallbackData);
    } finally {
      setLoading(false);
    }
  }, [equipmentTypes]);

  const updateChartForEquipment = useCallback(async (equipmentType: any) => {
    try {
      console.log(`ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ° Ð´Ð»Ñ: ${equipmentType.displayName}`);
      
      if (!rawData) {
        // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸Ñ…
        await fetchData();
        return;
      }
      
      const newChartData = hvacDataService.getChartDataForEquipment(rawData, equipmentType);
      
      if (newChartData.length > 0) {
        setChartData(newChartData);
        console.log(`âœ… Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½: ${equipmentType.displayName}, Ñ‚Ð¾Ñ‡ÐµÐº: ${newChartData.length}`);
      } else {
        const fallbackData = hvacDataService.generateFallbackChartData(
          equipmentType.defaultValue || 65,
          24,
          equipmentType.displayName
        );
        setChartData(fallbackData);
        console.log(`âš ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ fallback Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ${equipmentType.displayName}`);
      }
    } catch (error) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°:", error);
    }
  }, [rawData, fetchData]);

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
  useEffect(() => {
    const initServices = async () => {
      await hvacDataService.initialize();
      await equipmentTypeService.initialize();
      const types = equipmentTypeService.getAllEquipmentTypes();
      setEquipmentTypes(types);
    };
    
    initServices();
  }, []);

  // Polling
  useEffect(() => {
    fetchData();
    
    const interval = setInterval(fetchData, pollingInterval);
    return () => clearInterval(interval);
  }, [fetchData, pollingInterval]);

  return {
    parameters,
    chartData,
    loading,
    error,
    lastUpdate,
    refreshData: fetchData,
    rawData,
    equipmentTypes,
    updateChartForEquipment,
  };
};