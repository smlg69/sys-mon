// utils/encoding.ts - –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏–∑ Windows-1251 –≤ UTF-8
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
 */
export function decodeWindows1251(text: string): string {
  if (!text || typeof text !== 'string') return text;
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (!/–†–é|–†—û|–† –†|–†‚Ä∫|–†—ö|–†—ú/.test(text)) {
    return text;
  }
  
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º TextDecoder API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç windows-1251)
  try {
    if (typeof TextDecoder !== 'undefined') {
      const decoder = new TextDecoder('windows-1251');
      const bytes = new Uint8Array(text.length);
      
      for (let i = 0; i < text.length; i++) {
        bytes[i] = text.charCodeAt(i) & 0xFF;
      }
      
      const decoded = decoder.decode(bytes);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
      if (decoded !== text && !/–†–é|–†—û|–† –†|–†‚Ä∫|–†—ö|–†—ú/.test(decoded)) {
        return decoded;
      }
    }
  } catch (error) {
    // –ï—Å–ª–∏ TextDecoder –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    console.warn('TextDecoder –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ');
  }
  
  // –†—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
  return convertCp1251Manually(text);
}

/**
 * –†—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ CP1251 ‚Üí UTF-8 —á–µ—Ä–µ–∑ —Å–º–µ—â–µ–Ω–∏–µ
 */
function convertCp1251Manually(text: string): string {
  let result = '';
  
  for (let i = 0; i < text.length; i++) {
    const charCode = text.charCodeAt(i);
    
    // –†—É—Å—Å–∫–∏–µ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã –≤ CP1251: 0xC0-0xDF ‚Üí UTF-16: 0x0410-0x042F
    if (charCode >= 0xC0 && charCode <= 0xDF) {
      result += String.fromCharCode(charCode + 0x0350); // 0x0410 - 0xC0 = 0x0350
    }
    // –†—É—Å—Å–∫–∏–µ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã –≤ CP1251: 0xE0-0xFF ‚Üí UTF-16: 0x0430-0x044F
    else if (charCode >= 0xE0 && charCode <= 0xFF) {
      result += String.fromCharCode(charCode + 0x0350); // 0x0430 - 0xE0 = 0x0350
    }
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    else if (charCode === 0xA8) { // –Å
      result += '–Å';
    } else if (charCode === 0xB8) { // —ë
      result += '—ë';
    }
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    else {
      result += text[i];
    }
  }
  
  return result;
}

/**
 * –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Å –∑–∞–º–µ–Ω–æ–π –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã—Ö —Å–ª–æ–≤
 */
export function decodeWindows1251Simple(text: string): string {
  if (!text || typeof text !== 'string') return text;
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏
  if (!/–†–é|–†—û|–† –†|–†‚Ä∫|–†—ö|–†—ú/.test(text)) {
    return text;
  }
  
  let result = text;
  
  // –°–ø–∏—Å–æ–∫ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã—Ö —Å–ª–æ–≤ –¥–ª—è –∑–∞–º–µ–Ω—ã
  const commonWords = [
    // –°—Ç–∞—Ç—É—Å—ã
    { from: '–†–é–†—ï–†¬∑–†“ë–†¬∞–†–Ö–†¬∞', to: '–°–æ–∑–¥–∞–Ω–∞' },
    { from: '–†‚Äô –°–Ç–†¬∞–†¬±–†—ï–°‚Äö–†¬µ', to: '–í —Ä–∞–±–æ—Ç–µ' },
    { from: '–†‚Äî–†¬∞–†—î–°–Ç–°‚Äπ–°‚Äö–†¬∞', to: '–ó–∞–∫—Ä—ã—Ç–∞' },
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
    { from: '–†–é–°–Ç–†¬µ–†“ë–†–Ö–†—ë–†‚Ññ', to: '–°—Ä–µ–¥–Ω–∏–π' },
    { from: '–†‚Äô–°‚Äπ–°–É–†—ï–†—î–†—ë–†‚Ññ', to: '–í—ã—Å–æ–∫–∏–π' },
    { from: '–†—ú–†—ë–†¬∑–†—î–†—ë–†‚Ññ', to: '–ù–∏–∑–∫–∏–π' },
    { from: '–†—ô–°–Ç–†—ë–°‚Äö–†—ë–°‚Ä°–†¬µ–°–É–†—î–†—ë–†‚Ññ', to: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π' },
    // –¢–∏–ø—ã –∑–∞—è–≤–æ–∫
    { from: '–†—õ–†¬±–°–É–†¬ª–°—ì–†¬∂–†—ë–†–Ü–†¬∞–†–Ö–†—ë–†¬µ', to: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
    { from: '–†‚Äî–†¬∞–†—ò–†¬µ–†–Ö–†¬∞', to: '–ó–∞–º–µ–Ω–∞' },
    { from: '–† –†¬µ–†—ò–†—ï–†–Ö–°‚Äö', to: '–†–µ–º–æ–Ω—Ç' },
    { from: '–†—ú–†¬∞–°–É–°‚Äö–°–Ç–†—ï–†‚Ññ–†—î–†¬∞', to: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞' },
    // –§–∞–º–∏–ª–∏–∏
    { from: '–†¬ò–†–Ü–†¬∞–†–Ö–†—ï–†–Ü', to: '–ò–≤–∞–Ω–æ–≤' },
    { from: '–†–é–†—ò–†—ë–°–Ç–†–Ö–†—ï–†–Ü', to: '–°–º–∏—Ä–Ω–æ–≤' },
    { from: '–†‚Äô–†¬∞–°–É–†—ë–†¬ª–°–ä–†¬µ–†–Ü', to: '–í–∞—Å–∏–ª—å–µ–≤' },
    { from: '–†—ü–†—ï–†—ó–†—ï–†–Ü', to: '–ü–æ–ø–æ–≤' },
    { from: '–†–é–†—ë–†“ë–†—ï–°–Ç–†—ï–†–Ü', to: '–°–∏–¥–æ—Ä–æ–≤' },
    { from: '–†—ö–†¬∞–°‚Ä¶–†—ò–°—ì–†“ë–†—ï–†–Ü', to: '–ú–∞—Ö–º—É–¥–æ–≤' },
    // –ò–Ω–∏—Ü–∏–∞–ª—ã
    { from: '–†—í\\.–†‚Ä∫\\.', to: '–ê.–õ.' },
    { from: '–†—ö\\.–†–é\\.', to: '–ú.–°.' },
    { from: '–†—ü\\.–†—ô\\.', to: '–ü.–ö.' },
    { from: '–†‚Äù\\.–†‚Äô\\.', to: '–î.–í.' },
    { from: '–†¬ò\\.–†¬ò\\.', to: '–ò.–ò.' },
    { from: '–†¬ò\\.–†—ô\\.', to: '–ò.–ö.' },
  ];
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã
  commonWords.forEach(({ from, to }) => {
    result = result.replace(new RegExp(from, 'g'), to);
  });
  
  // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
  if (/–†–é|–†—û|–† –†|–†‚Ä∫|–†—ö|–†—ú/.test(result)) {
    result = convertCp1251Manually(result);
  }
  
  return result;
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–π –∑–∞—è–≤–∫–∏
 */
export function decodeOrder(order: any): any {
  if (!order || typeof order !== 'object') return order;
  
  const decoded: any = {};
  
  Object.keys(order).forEach(key => {
    const value = order[key];
    if (typeof value === 'string') {
      decoded[key] = decodeWindows1251(value);
    } else {
      decoded[key] = value;
    }
  });
  
  return decoded;
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –∑–∞—è–≤–æ–∫
 */
export function decodeOrdersArray(orders: any[]): any[] {
  if (!Array.isArray(orders)) return orders;
  
  return orders.map(order => decodeOrder(order));
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
 */
export function testDecoding(): void {
  const testCases = [
    { input: '–†—õ–†¬±–°–É–†¬ª–°—ì–†¬∂–†—ë–†–Ü–†¬∞–†–Ö–†—ë–†¬µ', expected: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
    { input: '–†–é–°–Ç–†¬µ–†“ë–†–Ö–†—ë–†‚Ññ', expected: '–°—Ä–µ–¥–Ω–∏–π' },
    { input: '–†¬ò–†–Ü–†¬∞–†–Ö–†—ï–†–Ü –†—ü.–†—ô.', expected: '–ò–≤–∞–Ω–æ–≤ –ü.–ö.' },
    { input: '–†—ü–°–Ç–†—ï–°‚Äû–†—ë–†¬ª–†¬∞–†—î–°‚Äö–†—ë–°‚Ä°–†¬µ–°–É–†—î–†—ï–†¬µ –†—ï–†¬±–°–É–†¬ª–°—ì–†¬∂–†—ë–†–Ü–†¬∞–†–Ö–†—ë–†¬µ', expected: '–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
  ];
  
  console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:');
  testCases.forEach(({ input, expected }) => {
    const result = decodeWindows1251(input);
    const passed = result === expected;
    console.log(`   ${passed ? '‚úÖ' : '‚ùå'} "${input}" ‚Üí "${result}" (–æ–∂–∏–¥–∞–ª–æ—Å—å: "${expected}")`);
  });
}