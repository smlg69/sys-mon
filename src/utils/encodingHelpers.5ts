// utils/encodingHelpers.ts

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ç–µ–∫—Å—Ç–∞
 */
export function detectEncoding(text: string): 'utf-8' | 'cp1251' | 'unknown' {
  if (!text) return 'unknown';
  
  // –ü—Ä–∏–∑–Ω–∞–∫–∏ CP1251
  const cp1251Pattern = /–†–é|–†—û|–† –†|–†‚Ä∫|–†—ö|–†—ú/;
  
  // –ü—Ä–∏–∑–Ω–∞–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ UTF-8 (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
  const utf8CyrillicPattern = /[–ê-–Ø–∞-—è–Å—ë]/;
  
  const hasCp1251 = cp1251Pattern.test(text);
  const hasUtf8Cyrillic = utf8CyrillicPattern.test(text);
  
  if (hasCp1251 && !hasUtf8Cyrillic) {
    return 'cp1251';
  } else if (!hasCp1251 && hasUtf8Cyrillic) {
    return 'utf-8';
  } else if (hasCp1251 && hasUtf8Cyrillic) {
    // –°–º–µ—à–∞–Ω–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞
    return 'cp1251';
  }
  
  return 'unknown';
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç hex —Å—Ç—Ä–æ–∫—É CP1251 –≤ UTF-8
 */
export function hexCp1251ToUtf8(hexString: string): string {
  const bytes = new Uint8Array(hexString.length / 2);
  for (let i = 0; i < hexString.length; i += 2) {
    bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
  }
  
  try {
    const decoder = new TextDecoder('windows-1251');
    return decoder.decode(bytes);
  } catch {
    // –†—É—á–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    let result = '';
    for (let i = 0; i < bytes.length; i++) {
      const charCode = bytes[i];
      if (charCode >= 0xC0 && charCode <= 0xFF) {
        result += String.fromCharCode(charCode + 0x0350);
      } else {
        result += String.fromCharCode(charCode);
      }
    }
    return result;
  }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—Å—Ç–µ
 */
export function debugTextEncoding(text: string): string {
  const encoding = detectEncoding(text);
  let info = `üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ (${text.length} —Å–∏–º–≤–æ–ª–æ–≤):\n`;
  info += `   –ö–æ–¥–∏—Ä–æ–≤–∫–∞: ${encoding}\n`;
  info += `   –ü–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤: "${text.substring(0, Math.min(10, text.length))}"\n`;
  info += `   –ö–æ–¥—ã —Å–∏–º–≤–æ–ª–æ–≤: `;
  
  for (let i = 0; i < Math.min(10, text.length); i++) {
    info += `'${text[i]}'=0x${text.charCodeAt(i).toString(16).toUpperCase()} `;
  }
  
  if (encoding === 'cp1251') {
    const decoded = decodeWindows1251(text);
    info += `\n   –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ: "${decoded.substring(0, Math.min(20, decoded.length))}"`;
  }
  
  return info;
}